<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ulesrend</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .classroomTable{
            border-collapse: collapse;
            width: 40%; 
            float: right; 
            margin-left: 20px; 
        }
        .studentsTable{
            border-collapse: collapse;
            width: 20%;
            float: left; 
            margin-right: 10%; 
            margin-top: 10%;
        }
        .dragHereTable{
            border-collapse: collapse;
            width: 10%; 
            margin-left: 40%; 
            margin-top: 10%;
        }
        .dragHereCell{
            border: 1px solid black;
            background-color: green; 
            width: 50px; height: 50px;
        }
        .draggable {
            width: 100%;
            height: 100%;
            background-color: #3498db;
            cursor: pointer;
        }
        .availablePlace{
            border: 1px solid black;
            background-color: grey; 
            width: 50px; height: 50px;
        }
        .teacherPlace{
            border: 1px solid black;
            background-color: darkslategray;
            color:aliceblue;
            width: 50px; height: 50px;
        }
        .nullPlace{
            border: 1px solid black;
            background-color: black;
            color:aliceblue;
            width: 50px; height: 50px;
        }
    </style>
</head>
<body>
    <button onclick="createClassroomTable()">CreateClassroom</button>
    <button onclick="createStudentsTable()">createStudents</button>
    <button onclick="save()">Save</button>
    <td class="null"></td>
</body>
<script>
    //tanterem alap {JELENLEG IDEIGLENES} -- TODO
    let classroom = [ 
        ["Keskeny kevin","Dancsik dávid",null,"Nobody","Gábor"],
        ["Korom Levente","Bogyó",null,"Nobody","Gergő"],
        ["Bene Dominik","Nobody",null,"Nobody","Nobody"],
        ["Gere Csanad","Jani Patrik",null,"Gyula","Nobody"],
        ["Tanár",null,null,"Barna Máté","Barta Máte"]
    ]

    //diaklista {JELENLEG IDEIGLENES} -- TODO
    let studentList = [ 
        "Jani Patrik",
        "Gere Csanad",
        "Gyula",
        "Mate1",
        "Mate2"
    ]

    let classroomColloums = 6 //oszlopok szama {JELENLEG IDEIGLENES} --  TODO
    let classroomRows = 6 //sorok szama {JELENLEG IDEIGLENES} -- TODO

    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event) {
        event.dataTransfer.setData("text/plain", event.target.id);
    }

    function drop(event) {
        event.preventDefault();

        var data = event.dataTransfer.getData("text/plain");

        var draggedDiv = document.getElementById(data);

        var containsText = false;

        for (var i = 0; i < event.target.childNodes.length; i++) {
            if (event.target.childNodes[i].nodeName === '#text') {
                containsText = true;
                break;
            }
        }

        if(containsText == false && event.target.id != "Students" && document.getElementById(event.target.id).childNodes.length == 0){
            
            event.target.appendChild(draggedDiv);

            if(document.getElementById(draggedDiv.id+"-x")){
                document.getElementById(draggedDiv.id+"-x").remove()
            }
            if(document.getElementById("Students-"+draggedDiv.id)){
                document.getElementById("Students-"+draggedDiv.id).remove()
            }
        }
        if (event.target.id == "dragHere"){
            if(document.getElementById(draggedDiv.id+"-x")){
                document.getElementById(draggedDiv.id+"-x").remove()
            }
            if(document.getElementById("Students-"+draggedDiv.id)){
                document.getElementById("Students-"+draggedDiv.id).remove()
            }
            var row = document.createElement("tr");
            var cell = document.createElement("td");
            cell.setAttribute('class', 'availablePlace')
            cell.setAttribute('id', draggedDiv.id+"-x")
            cell.appendChild(draggedDiv)
            row.appendChild(cell);
            document.getElementById("Students").appendChild(row);
        }
    }

    function createClassroomTable() {
        if(document.getElementById("classroom")){ document.getElementById("classroom").remove() }

        var table = document.createElement("table");
        table.setAttribute('id', 'classroom')
        table.setAttribute('class', 'classroomTable')

        var tbody = document.createElement("tbody");

        for (var i = 0; i < classroomRows-1; i++) {

            var row = document.createElement("tr");

            for (var j = 0; j < classroomColloums-1; j++) {

                var cell = document.createElement("td");
                cell.setAttribute('id', (i + 1) +"-"+ (j + 1))

                if(classroom[i][j] != null){

                    if(classroom[i][j] != "Nobody" && classroom[i][j] != "Tanár"){
                        var div = document.createElement("div")
                        div.setAttribute('id', (i + 1) +"x"+ (j + 1))
                        div.setAttribute('draggable', 'true')
                        div.setAttribute('class', 'draggable')
                        div.appendChild(document.createTextNode(classroom[i][j]))
                        cell.appendChild(div);
                    } if(classroom[i][j] != "Tanár"){
                        cell.addEventListener('dragover', allowDrop);
                        cell.addEventListener('drop', drop);
                        cell.setAttribute('class', 'availablePlace')
                    } else { 
                        cell.setAttribute('class', 'teacherPlace')
                        cell.appendChild(document.createTextNode(classroom[i][j]))
                    }
                } else {
                    cell.setAttribute('class', "nullPlace")
                    cell.appendChild(document.createTextNode("Folyoso"))
                }
                row.appendChild(cell);
            }

            tbody.appendChild(row);
        }

        table.appendChild(tbody);

        document.body.appendChild(table);

        var draggableDivs = document.querySelectorAll('.draggable');

        draggableDivs.forEach(function(div) {
            div.addEventListener('dragstart', drag);
        });
    }

    function createStudentsTable(){
        if(document.getElementById("studentList")){ document.getElementById("studentList").remove() }
        if(!document.getElementById("classroom")){ alert("Eloszor kotelezo a tanterem beimportalasa") }
        else{
            var table = document.createElement("table");
            table.setAttribute('id', 'studentList')
            table.setAttribute('class', 'studentsTable')

            var tbody = document.createElement("tbody");
            tbody.setAttribute('id', 'Students');

            for (var i = 0; i < studentList.length; i++) {
                if(!checkDuplactedStudents(classroom, studentList[i])){
                    var row = document.createElement("tr");
                    var cell = document.createElement("td");
                    cell.setAttribute('id', "Students-"+i)
                    cell.addEventListener('dragover', allowDrop);
                    cell.addEventListener('drop', drop);
                    cell.setAttribute('class', 'availablePlace')
                    var div = document.createElement("div")
                    div.setAttribute('id', i)
                    div.setAttribute('draggable', 'true')
                    div.setAttribute('class', 'draggable')
                    div.appendChild(document.createTextNode(studentList[i]))
                    cell.appendChild(div);
                    row.appendChild(cell);
                    tbody.appendChild(row);
                }
            }

            table.appendChild(tbody);

            document.body.appendChild(table);

            var table = document.createElement("table");
            table.setAttribute('class', 'dragHereTable')
            var tbody = document.createElement("tbody");
            var row = document.createElement("tr");
            var cell = document.createElement("td");
            cell.setAttribute('class', 'dragHereCell')
            cell.setAttribute('id', 'dragHere')
            cell.appendChild(document.createTextNode("Drag here"))
            cell.addEventListener('dragover', allowDrop);
            cell.addEventListener('drop', drop);
            row.appendChild(cell);
            tbody.appendChild(row);
            table.appendChild(tbody);
            document.body.appendChild(table);

            var draggableDivs = document.querySelectorAll('.draggable');

            draggableDivs.forEach(function(div) {
                div.addEventListener('dragstart', drag);
            });
        }
    }

    function save(){
        let classroomSave = createDynamicArray(classroomRows, classroomColloums)
        /*let classroomSave = [[null,null,null,null,null],
                            [null,null,null,null,null],
                            [null,null,null,null,null],
                            [null,null,null,null,null],
                            [null,null,null,null,null]]*/
        for (var i = 0; i < classroomRows-1; i++) {
            for (var j = 0; j < classroomColloums-1; j++) {

                let id = (i+1)+"-"+(j+1);
                let element = document.getElementById(id);

                if(element.childNodes.length != 0){
                    if(element.textContent != "Folyoso"){
                        classroomSave[i][j] = element.textContent
                    } else{
                        classroomSave[i][j] = null
                    }
                } 
                if(element.childNodes.length == 0 && element.className != "null"){
                    classroomSave[i][j] = "Nobody"
                    console.log(element.value)
                }
            }
        }

        let downloadableFile = ""
        
        for(var i = 0; i < classroomSave.length; i++){
            if(i != 0){downloadableFile+="\n"}
            for(var j = 0; j < classroomSave[i].length; j++){
                downloadableFile+= classroomSave[i][j]+";"
            }
        }
        const link = document.createElement("a");

        const file = new Blob([downloadableFile], { type: 'text/plain' });

        link.href = URL.createObjectURL(file);

        link.download = "Classroom.json"

        link.click();

        URL.revokeObjectURL(link.href);
    }

    function createDynamicArray(Rows, Colloums){
        let classroomSave = new Array(classroomRows-1)
        for (var i = 0; i < classroomRows-1; i++) {
            classroomSave[i] = new Array(classroomColloums-1)
            for (var j = 0; j < classroomColloums-1; j++) {
                classroomSave[i][j] = null
            }
        }
        
        return classroomSave;
    }

    function checkDuplactedStudents(classroom, student){
        let exist = false

        for (var i = 0; i < classroomRows-1; i++) {
            for (var j = 0; j < classroomColloums-1; j++) {
                if(classroom[i][j] == student){exist = true}
            }
        }

        return exist
    }
</script>
</html>
